/*! Asteroids 27-12-2013 */
!function(a){a.sample=a.sample||function(a){sampleArray=[],a=a||1;for(var b=0;a>b;b++)sampleArray.push(this[Math.floor(Math.random()*this.length)]);return 1==a?sampleArray[0]:sampleArray},a.normalize=a.normalize||function(){var a=this.mag();return this.map(function(b){return b/a})},a.rotate=a.rotate||function(a){if(2!=this.length)return!1;var b=[];return b.push(Math.cos(a)*this[0]+Math.sin(a)*this[1]),b.push(Math.cos(a)*this[1]-Math.sin(a)*this[0]),b},a.scale=a.scale||function(a){return this.map(function(b){return b*a})},a.add=a.add||function(a){for(var b=[],c=0;c<a.length;c++)this[c]?b.push(this[c]+a[c]):b.push(a[c]);return b},a.subtract=a.subtract||function(a){for(var b=[],c=0;c<a.length;c++)this[c]?b.push(this[c]-a[c]):b.push(-a[c]);return b},a.pow=a.pow||function(a){return this.map(function(b){return Math.pow(b,a)})},a.mag=a.mag||function(){var a=this.map(function(a){return a*a}),b=a.reduce(function(a,b){return a+=b});return Math.sqrt(b)},a.distance=a.distance||function(a){if(this.length!=a.length)return!1;var b=this[0]-a[0],c=this[1]-a[1];return Math.sqrt(b*b+c*c)},a.remove=a.remove||function(a){for(var b=0;b<this.length;b++)if(a===this[b])return this.splice(b,1),this;return!1},a.uniq=a.uniq||function(){for(var a={},b=[],c=0;c<this.length;c++)a[this[c]]||(a[this[c]]=!0,b.push(this[c]));return b}}(Array.prototype),function(a){a.inherits=a.inherits||function(a,b){function c(){}c.prototype=b.prototype,a.prototype=new c}}(this);var Asteroids=this.Asteroids||{};!function(a){var b=a.Store=a.Store||{};b.randomVel=function(b){var c=Math.random()*a.Asteroid.maxSpeed(b)*[-1,1].sample(),d=Math.random()*a.Asteroid.maxSpeed(b)*[-1,1].sample();return[c,d]},b.randomColor=function(){for(var a="#",b=0;6>b;b++)a+=[1,2,3,4,5,6,7,8,9,"A","B","C","D","E","F"].sample();return a}}(Asteroids);var Asteroids=this.Asteroids=this.Asteroids||{};!function(a){MovingObject=a.MovingObject=function(a,b,c,d){this.radius=c,this.color=d,this.pos=a,this.vel=b},MovingObject.prototype.move=function(){this.pos[0]+=this.vel[0],this.pos[1]+=this.vel[1]},MovingObject.prototype.draw=function(a){a.fillStyle=this.color,a.beginPath(),a.arc(this.pos[0],this.pos[1],this.radius,0,2*Math.PI,!1),a.fill()},MovingObject.prototype.isCollidedWith=function(a){var b=a.radius,c=this.pos.distance(a.pos);return b+this.radius>c?!0:!1},MovingObject.prototype.start=function(){var a=canvasEl.getContext("2d");window.setInterval(function(){as1.move(),as1.draw(a)},100)}}(Asteroids);var Asteroids=this.Asteroids=this.Asteroids||{};!function(a){var b=a.Store,c=a.Asteroid=function(a,c,d,e){var e=e||b.randomColor();MovingObject.call(this,a,c,d,e),this.health=this.radius};inherits(c,MovingObject),c.MAX_SPEED_MULTIPLIER=1,c.RADII=[40,25,10],c.maxSpeed=function(a){return a=a||c.RADII[0],c.MAX_SPEED_MULTIPLIER/5*Math.log(a)},c.randomAsteroid=function(a){var d=c.RADII[0];if([!0,!1].sample())var e=Math.random()*a,f=-d;else var e=-d,f=Math.random()*a;var g=b.randomVel(d),h=[e,f];return new c(h,g,d)},c.prototype.explode=function(){var a=c.RADII[c.RADII.indexOf(this.radius)+1];if(!a)return[];for(var d,e=[],f=0;3>f;f++){var g=[];g[0]=this.pos[0],g[1]=this.pos[1],d=b.randomVel(a),e.push(new c(g,d,a))}return e}}(Asteroids);var Asteroids=this.Asteroids||{};!function(a){Game=a.Game=function(a){this.canvas=a,this.ctx=a.getContext("2d"),this.WIDTH=a.width,this.HEIGHT=a.height,this.asteroids=[],this.noExplodeAsteroids=[],this.bullets=[],this.FPS=30,this.repopulationRate=5,this.difficultyRate=.2,this.bgColor="white",this.dropShadowColor="red",this._counter=0},Game.prototype.addAsteroids=function(b){for(var c=0;b>c;c++)this.asteroids.push(a.Asteroid.randomAsteroid(this.WIDTH,this.HEIGHT))},Game.prototype.addShip=function(){this.ship=new a.Ship([this.WIDTH/2,this.HEIGHT/2])},Game.prototype.fire=function(){this.bullets.push(this.ship.fire())},Game.prototype.draw=function(){var a=this;this.ctx.clearRect(0,0,this.WIDTH,this.HEIGHT),this.asteroids.forEach(function(b){b.draw(a.ctx)}),this.bullets.forEach(function(b){b.draw(a.ctx)}),this.ship.draw(this.ctx)},Game.prototype.move=function(){this.asteroids.forEach(function(a){a.move()}),this.ship.move(),this.bullets.forEach(function(a){a.move()})},Game.prototype.clearOOBAsteroids=function(){for(var a,b,c,d=0;d<this.asteroids.length;d++)c=this.asteroids[d],a=c.pos[0],b=c.pos[1],(a-c.RADIUS>this.WIDTH||a+c.RADIUS<0||b-c.RADIUS>this.HEIGHT||b+c.RADIUS<0)&&(this.asteroids.splice(d,1),this.addAsteroids(1))},Game.prototype.clearOOBBullets=function(){for(var a,b,c,d=0;d<this.bullets.length;d++)a=this.bullets[d],b=a.pos[0],c=a.pos[1],(0>b||0>c||b>this.WIDTH||c>this.HEIGHT)&&this.bullets.splice(d,1)},Game.prototype.wrapMovingObjects=function(){var a=this,b=[];b=b.concat(a.asteroids),movingOBjects=b.push(a.ship),b.forEach(function(b){b.pos[0]+b.radius<0&&(b.pos[0]+=a.WIDTH+2*b.radius),b.pos[1]+b.radius<0&&(b.pos[1]+=a.HEIGHT+2*b.radius),b.pos[0]-b.radius>a.WIDTH&&(b.pos[0]-=a.WIDTH+2*b.radius),b.pos[1]-b.radius>a.HEIGHT&&(b.pos[1]-=a.HEIGHT+2*b.radius)})},Game.prototype.asteroidCollisionPairs=function(){for(var a=[],b=0;b<this.asteroids.length;b++)for(var c=b+1;c<this.asteroids.length;c++)this.asteroids[b].isCollidedWith(this.asteroids[c])&&a.push([this.asteroids[b],this.asteroids[c]]);return a},Game.prototype.asteroidCollisions=function(){return this.asteroidCollisionPairs().uniq},Game.prototype.hitAsteroids=function(){var a=this,b=[];return this.bullets.forEach(function(c){a.asteroids.forEach(function(a){c.isCollidedWithAsteroid(a)&&b.push(a)})}),b},Game.prototype.collidedBullets=function(){var a=this,b=[];return this.bullets.forEach(function(c){a.asteroids.forEach(function(a){c.isCollidedWithAsteroid(a)&&b.push(c)})}),b},Game.prototype.explodeAsteroidsIfCollided=function(){var a=this;this.asteroidCollisions().forEach(function(b){-1===a.noExplodeAsteroids.indexOf(b)&&a.explodeAsteroid(b)})},Game.prototype.damageAsteroidsIfCollided=function(){var a=this;this.asteroidCollisionPairs().forEach(function(b){-1===a.noExplodeAsteroids.indexOf(b[0])&&a.damageAsteroid(b[0],b[1].radius)})},Game.prototype.damageAsteroidIfHit=function(){var a=this;this.hitAsteroids().forEach(function(b){a.damageAsteroid(b,a.ship.damage)})},Game.prototype.depopulateNoExplodeAsteroids=function(){var a=this;this.noExplodeAsteroids.forEach(function(b){var c=a.noExplodeAsteroids.every(function(a){return b===a?!0:!b.isCollidedWith(a)});c&&a.noExplodeAsteroids.remove(b)})},Game.prototype.explodeAsteroid=function(a){this.asteroids.remove(a);var b=a.explode();this.noExplodeAsteroids=this.noExplodeAsteroids.concat(b),this.asteroids=this.asteroids.concat(b)},Game.prototype.explodeAsteroidsIfDestroyed=function(){var a=this;this.asteroids.forEach(function(b){b.health<=0&&a.explodeAsteroid(b)})},Game.prototype.damageAsteroid=function(a,b){a.health-=b},Game.prototype.removeBullet=function(a){this.bullets.remove(a)},Game.prototype.damageShipIfHit=function(){var b=this;this.asteroids.forEach(function(c){b.ship.isCollidedWith(c)&&(b.explodeAsteroid(c),a.Visuals.Hit(b.canvas),b.ship.health-=c.radius)})},Game.prototype.repopulateAsteroids=function(){this._counter%(this.FPS*this.repopulationRate)==0&&this.addAsteroids(1)},Game.prototype.modifyDifficulty=function(){this._counter%(this.FPS*this.repopulationRate)==0&&this.changeAsteroidSpeed(this.difficultyRate)},Game.prototype.changeAsteroidSpeed=function(a){Asteroids.Asteroid.MAX_SPEED_MULTIPLIER+=a},Game.prototype.handleCollidingAsteroids=function(){this.damageAsteroidsIfCollided(),this.explodeAsteroidsIfDestroyed(),this.depopulateNoExplodeAsteroids()},Game.prototype.handleHitAsteroids=function(){this.damageAsteroidIfHit()},Game.prototype.handleHitShip=function(){this.damageShipIfHit()},Game.prototype.handleCollidedBullets=function(){var a=this;this.collidedBullets().forEach(function(b){a.removeBullet(b)})},Game.prototype.step=function(){this._counter+=1,this.modifyDifficulty(),this.clearOOBBullets(),this.wrapMovingObjects(),this.handleCollidingAsteroids(),this.handleHitAsteroids(),this.handleHitShip(),this.handleCollidedBullets(),this.repopulateAsteroids(),this.draw(),this.move()},Game.prototype.pause=function(){this.mainTimer?this.stop():this.start()},Game.prototype.stop=function(){clearInterval(this.mainTimer),delete this.mainTimer},Game.prototype.start=function(){var a=this;this.mainTimer=window.setInterval(function(){a.step()},a.FPS)},Game.prototype.initialize=function(){this.addAsteroids(5),this.addShip(),new a.Listener(this),this.start(),document.getElementsByTagName("body")[0].bgColor=this.bgColor},Game.prototype.setUp=function(){this.asteroids=[],this.noExplodeAsteroids=[],this.addAsteroids(1),this.asteroids[0].vel=[0,0],this.ship.pos=[100,100],this.asteroids[0].pos=[250,250]}}(Asteroids);var Asteroids=this.Asteroids||{};!function(a){var b=a.Ship=function(b){var b=b,c=[0,0],d=20/3;this.orientation=[0,-1],this.rotateSpeed=.25,this.impulse=.4,this.dampenRate=.95,this.fireFrequency=200,this.health=40,this.damage=15,a.MovingObject.call(this,b,c,d,"black")};inherits(b,MovingObject),b.prototype.power=function(){this.vel=this.vel.add(this.orientation.scale(this.impulse))},b.prototype.turn=function(a,b){if("left"===a)var c=1;else var c=-1;this.orientation=this.orientation.rotate(c*this.rotateSpeed*b)},b.prototype.dampen=function(){var a=this.dampenRate;this.vel.mag()<3?(a=.5,this.vel=this.vel.scale(a)):(a=this.dampenRate,this.vel=this.vel.scale(a))},b.prototype.fire=function(){return new a.Bullet(this)},b.prototype.draw=function(a){var b=3*this.radius,c=.3,d=this.orientation,e=this.pos,f=e.add(d.scale(b/1.5)),g=f.add(d.scale(-b).rotate(c)),h=f.add(d.scale(-b).rotate(-c)),i=f;a.fillStyle="black",a.strokeStyle="red",a.lineWidth=3,a.beginPath(),a.moveTo(f[0],f[1]),a.lineTo(g[0],g[1]),a.lineTo(h[0],h[1]),a.lineTo(i[0],i[1]),a.closePath(),a.stroke(),a.fill()}}(Asteroids);var Asteroids=this.Asteroids=this.Asteroids||{};!function(a){var b=a.Listener=function(a){this.timers={},this.game=a,this.listen()};b.prototype.listen=function(){this.listenUp(),this.listenDown()},b.prototype.listenUp=function(){var a=this;document.onkeyup=function(b){switch(b.keyCode){case 37:case 65:clearInterval(a.timers.left),delete a.timers.left;break;case 39:case 68:clearInterval(a.timers.right),delete a.timers.right;break;case 38:case 87:clearInterval(a.timers.move),delete a.timers.move;break;case 40:case 83:clearInterval(a.timers.dampen),delete a.timers.dampen;break;case 32:clearInterval(a.timers.fire),delete a.timers.fire}}},b.prototype.listenDown=function(){var a=this;document.onkeydown=function(b){switch(b.keyCode){case 65:case 37:a.setTurnTimer("left");break;case 39:case 68:a.setTurnTimer("right");break;case 38:case 87:a.setMoveTimer();break;case 40:case 83:a.setDampenTimer();break;case 32:a.fire();break;case 80:a.game.pause()}}},b.prototype.setTurnTimer=function(a){var b=this;if(!this.timers[a]){var c=0;this.timers[a]=setInterval(function(){c+=.2,c>1&&(c=1),b.game.ship.turn(a,c)},b.game.FPS)}},b.prototype.setMoveTimer=function(){var a=this;this.timers.move||(this.timers.move=setInterval(function(){a.game.ship.power()},a.game.FPS))},b.prototype.setDampenTimer=function(){var a=this;this.timers.dampen||(this.timers.dampen=setInterval(function(){a.game.ship.dampen()},a.game.FPS))},b.prototype.fire=function(){var a=this;this.timers.fire||(this.game.fire(),this.timers.fire=setInterval(function(){a.game.fire()},a.game.ship.fireFrequency))}}(Asteroids);var Asteroids=this.Asteroids=this.Asteroids||{};!function(a){var b=a.Bullet=function(a){this.ship=a,this.orientation=a.orientation.slice(0);var b=a.vel.add(a.orientation.scale(10)),c=a.pos.slice(0),d="red";MovingObject.call(this,c,b,null,d)};inherits(b,MovingObject),b.prototype.draw=function(a){var b=this.pos,c=this.pos.add(this.orientation.scale(10));a.beginPath(),a.moveTo(b[0],b[1]),a.lineTo(c[0],c[1]),a.lineWidth=3,a.strokeStyle=this.color,a.stroke()},b.prototype.isCollidedWithAsteroid=function(a){return this.pos.distance(a.pos)<=a.radius?!0:!1}}(Asteroids);var Asteroids=this.Asteroids=this.Asteroids||{};!function(a){var b=a.Visuals=function(){};b.Hit=function(a){a.setAttribute("style","transition: all 0.1s; box-shadow: inset 0 0 30px 30px red;"),setTimeout(function(){a.setAttribute("style","transition: all 0.1s")},100)}}(Asteroids),window.onload=function(){var a=document.createElement("canvas");a.setAttribute("width","500"),a.setAttribute("height","500");var b=document.getElementById("canvas-wrapper");b.appendChild(a);var c=new window.Asteroids.Game(a);c.initialize(),window.game=c};